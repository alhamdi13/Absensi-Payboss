<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PayBoss ‚Äì Sistem Absensi (Stabil)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg: #f0f4f8;
      --surface: #ffffff;
      --text: #1e293b;
      --primary: #2563eb;
      --secondary: #64748b;
    }
    body { background: var(--bg); color: var(--text); }
    .card { background: var(--surface); border-radius: 1rem; box-shadow: 0 10px 25px -10px rgba(0,0,0,.15); }
    .toast { position: fixed; right: 16px; bottom: 16px; z-index: 9999; padding: 12px 16px; border-radius: 12px; box-shadow: 0 10px 25px -10px rgba(0,0,0,.25); }
    .toast-success { background:#dcfce7; color:#166534; border-left:4px solid #22c55e; }
    .toast-error { background:#fee2e2; color:#991b1b; border-left:4px solid #ef4444; }
    .toast-warning { background:#fef3c7; color:#92400e; border-left:4px solid #f59e0b; }
    #canvas { display:none; }
  </style>
</head>
<body class="min-h-screen">
  <div id="app" class="min-h-screen"></div>

  <!-- Modal Kamera -->
  <div id="cameraModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="card w-full max-w-2xl p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold">Ambil Foto Absensi</h3>
        <button id="closeCameraBtn" class="px-3 py-1 rounded bg-slate-200 text-slate-700">Tutup</button>
      </div>
      <div class="relative">
        <video id="video" autoplay playsinline class="w-full rounded"></video>
        <canvas id="canvas"></canvas>
      </div>
      <div class="mt-4 flex gap-3">
        <button id="captureBtn" class="flex-1 px-4 py-3 rounded bg-[color:var(--primary)] text-white font-semibold">üì∏ Ambil Foto</button>
        <button id="cancelCameraBtn" class="px-4 py-3 rounded bg-slate-200 text-slate-700">Batal</button>
      </div>
    </div>
  </div>

  <script>
  // ========= KONFIGURASI =========
  const GAS_URL = "https://script.google.com/macros/s/AKfycbzzAMcyxm1qjtXdjgKROgS0QqA2S4L7TbZBKabKB8r2fJUIwzLPrU76dcxJH9MHkMoiag/exec"; // ganti jika perlu

  const defaultConfig = {
    background_color: getComputedStyle(document.documentElement).getPropertyValue('--bg').trim() || '#f0f4f8',
    surface_color: getComputedStyle(document.documentElement).getPropertyValue('--surface').trim() || '#ffffff',
    text_color: getComputedStyle(document.documentElement).getPropertyValue('--text').trim() || '#1e293b',
    primary_color: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2563eb',
    secondary_color: getComputedStyle(document.documentElement).getPropertyValue('--secondary').trim() || '#64748b',
    app_title: 'PayBoss',
    company_tagline: 'Sistem Absensi & Manajemen Kepegawaian',
    shift1_label: 'Shift Pagi',
    shift2_label: 'Shift Sore',
    shift3_label: 'Shift Malam',
    font_size: 16,
    font_family: 'Inter'
  };

  // ========= STATE =========
  let currentView = 'login'; // 'login' | 'attendance' | 'admin'
  let currentRole = null;    // 'employee' | 'admin'
  let attendanceType = 'checkin';
  let stream = null;         // camera stream

  // data yang diisi dari GAS saat init
  let allRecords = []; // campuran employee, attendance, roster, work_hours, leave_request, overtime_report
  let employees = [];
  let attendances = [];
  let rosters = [];
  let workHours = [];

  // ========= SDK GOOGLE APPS SCRIPT =========
  const dataSdk = {
    async init() {
      try {
        const res = await fetch(GAS_URL);
        const json = await res.json();
        if (!json || json.isOk === false) throw new Error(json?.error || 'Init gagal');
        return json; // { isOk: true, data: [...] }
      } catch (e) {
        console.error('INIT ERROR:', e);
        showToast('Gagal mengambil data dari Google Sheet', 'error');
        return { isOk:false, data:[] };
      }
    },
    async create(payload) {
      try {
        const res = await fetch(GAS_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        return await res.json();
      } catch (e) {
        console.error('CREATE ERROR:', e); return { isOk:false, error:String(e) };
      }
    },
    async update(payload) {
      try {
        const res = await fetch(GAS_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        return await res.json();
      } catch (e) {
        console.error('UPDATE ERROR:', e); return { isOk:false, error:String(e) };
      }
    },
    async delete(payload) {
      try {
        const res = await fetch(GAS_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ...payload, __operation:'delete' }) });
        return await res.json();
      } catch (e) {
        console.error('DELETE ERROR:', e); return { isOk:false, error:String(e) };
      }
    }
  };

  // ========= UTIL =========
  function showToast(msg, type='success') {
    const el = document.createElement('div');
    el.className = `toast toast-${type}`;
    el.textContent = msg;
    document.body.appendChild(el);
    setTimeout(()=>el.remove(), 2600);
  }
  function formatDate(iso) {
    const d=new Date(iso);return d.toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'});
  }
  function formatTime(iso) {
    const d=new Date(iso);return d.toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'});
  }
  function getShiftLabel(n) {
    const labels={ '1':defaultConfig.shift1_label, '2':defaultConfig.shift2_label, '3':defaultConfig.shift3_label };
    return labels[n] || `Shift ${n}`;
  }

  // ========= KAMERA =========
  async function startCamera() {
    const modal = document.getElementById('cameraModal');
    const video = document.getElementById('video');
    if (!modal || !video) return;
    modal.classList.remove('hidden');
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user', width:{ideal:1280}, height:{ideal:720} } });
      video.srcObject = stream;
    } catch(err) {
      console.error(err); showToast('Izin kamera ditolak / tidak tersedia', 'error');
    }
  }
  function stopCamera() {
    if (stream) { stream.getTracks().forEach(t=>t.stop()); stream=null; }
    const modal = document.getElementById('cameraModal');
    if (modal) modal.classList.add('hidden');
  }
  function capturePhoto() {
    const video=document.getElementById('video');
    const canvas=document.getElementById('canvas');
    if (!video || !canvas) return null;
    canvas.width=video.videoWidth||1280; canvas.height=video.videoHeight||720;
    const ctx=canvas.getContext('2d'); ctx.drawImage(video,0,0,canvas.width,canvas.height);
    return canvas.toDataURL('image/jpeg',0.85);
  }

  // ========= ABSENSI =========
  function detectShift(date){
    const m=date.getHours()*60+date.getMinutes();
    if (m>=465 && m<=975) return '1';     // 07:45‚Äì16:15
    if (m>=945 || m<=15)  return '2';     // 15:45‚Äì00:15
    if (m>=1425 || m<=495)return '3';     // 23:45‚Äì08:15
    return '1';
  }
  const SHIFTS={ '1':{start:8,grace:15}, '2':{start:16,grace:15}, '3':{start:0,grace:15} };
  function getAttendanceStatus(detected, scheduled, time){
    if (detected!==scheduled) return 'tidak-sesuai';
    const minutes = time.getHours()*60+time.getMinutes();
    const start = (SHIFTS[detected]?.start||8)*60;
    return minutes>start+(SHIFTS[detected]?.grace||15) ? 'terlambat' : 'hadir';
  }

  async function doAttendance(nik, type){
    // cari employee
    const emp = employees.find(e=>e.nik===nik && (e.status||'aktif')==='aktif');
    if (!emp) { showToast('NIK tidak ditemukan / tidak aktif','error'); return; }

    attendanceType = type; await startCamera();

    // tombol modal di-bind ulang setiap buka kamera
    const captureBtn = document.getElementById('captureBtn');
    const cancelBtn  = document.getElementById('cancelCameraBtn');
    const closeBtn   = document.getElementById('closeCameraBtn');
    const cleanup = ()=>{
      captureBtn.onclick=null; cancelBtn.onclick=null; closeBtn.onclick=null; stopCamera();
    };
    cancelBtn.onclick = cleanup; closeBtn.onclick = cleanup;

    captureBtn.onclick = async () => {
      captureBtn.disabled=true; captureBtn.textContent='Memproses‚Ä¶';
      const photo = capturePhoto();
      if (!photo) { showToast('Gagal mengambil foto','error'); captureBtn.disabled=false; captureBtn.textContent='üì∏ Ambil Foto'; return; }

      const now = new Date();
      const todayStr = new Date().toISOString().split('T')[0];
      const rToday = rosters.find(r=>r.nik===emp.nik && r.tanggal===todayStr);
      const scheduled = rToday ? rToday.shift_roster : (emp.shift_tetap||'1');
      if (['OFF','CUTI','IJIN'].includes(scheduled)) { showToast(`Hari ini ${scheduled==='OFF'?'LIBUR':scheduled}.`, 'warning'); cleanup(); return; }

      const detected = detectShift(now);
      const status = getAttendanceStatus(detected, scheduled, now);

      const payload = {
        type:'attendance',
        nik: emp.nik, nama: emp.nama, posisi: emp.posisi,
        shift_tetap: emp.shift_tetap, waktu_absen: now.toISOString(),
        shift_terdeteksi: detected, shift_jadwal: scheduled,
        foto_data: photo, lokasi:'Lokasi Kerja', status_absen: status,
        attendance_type: type
      };

      // hitung jam kerja saat checkout
      if (type==='checkout'){
        const todayIns = attendances.filter(a=> a.nik===emp.nik && a.attendance_type==='checkin' && a.waktu_absen.split('T')[0]===todayStr);
        if (todayIns.length){
          const ms = now - new Date(todayIns[0].waktu_absen);
          const minutes = Math.max(0, Math.round(ms/60000));
          await dataSdk.create({
            type:'work_hours', nik:emp.nik, nama:emp.nama, tanggal:todayStr,
            jam_masuk: todayIns[0].waktu_absen, jam_keluar: now.toISOString(),
            total_menit: minutes, total_jam: +(minutes/60).toFixed(2), shift: detected
          });
        }
      }

      const res = await dataSdk.create(payload);
      cleanup();
      if (res?.isOk){ showToast(`${type==='checkout'?'Absen pulang':'Absen masuk'} tercatat!`,'success'); await refreshData(); render(); }
      else { showToast('Gagal menyimpan absensi','error'); }
    };
  }

  // ========= ROSTER SEDERHANA =========
  function generateWeeklyRoster(){
    const today = new Date();
    const start = new Date(today); start.setDate(today.getDate()-today.getDay()); // Minggu
    const actives = employees.filter(e=>(e.status||'aktif')==='aktif');
    const out=[];
    for(let d=0; d<7; d++){
      const cur = new Date(start); cur.setDate(start.getDate()+d);
      const dateStr = cur.toISOString().split('T')[0];
      actives.forEach((e, idx)=>{
        let s = e.shift_tetap||'1';
        // rotasi sederhana biar merata
        const r = (idx + d) % 3; s = String((r%3)+1);
        out.push({ type:'roster', nik:e.nik, nama:e.nama, posisi:e.posisi, tanggal:dateStr, shift_roster:s, jam_kerja_normal:8, keterangan:`${getShiftLabel(s)} ‚Äì 8 jam` });
      });
    }
    return out;
  }
  async function saveWeeklyRoster(){
    const have = rosters && rosters.length>0;
    if (have){ showToast('Roster sudah ada. Hapus dulu jika ingin mengganti.','warning'); return; }
    const data = generateWeeklyRoster();
    let ok=0; for (const row of data){ const r=await dataSdk.create(row); if (r?.isOk) ok++; }
    showToast(`Roster dibuat (${ok}/${data.length})`,'success');
    await refreshData(); render();
  }

  async function clearRoster(){
    let ok=0; for (const r of rosters){ const res=await dataSdk.delete(r); if (res?.isOk) ok++; }
    showToast(`Roster terhapus: ${ok}`,'success');
    await refreshData(); render();
  }

  // ========= DATA LOADER =========
  async function refreshData(){
    const init = await dataSdk.init();
    allRecords = Array.isArray(init.data)? init.data : [];
    employees   = allRecords.filter(r=>r.type==='employee');
    attendances = allRecords.filter(r=>r.type==='attendance');
    rosters     = allRecords.filter(r=>r.type==='roster');
    workHours   = allRecords.filter(r=>r.type==='work_hours');
  }

  // ========= RENDER =========
  function renderLogin(){
    return `
      <div class="min-h-screen flex items-center justify-center p-6">
        <div class="w-full max-w-md card p-8">
          <div class="text-center mb-6">
            <div class="text-6xl mb-2">üëî</div>
            <h1 class="text-2xl font-bold mb-1">${defaultConfig.app_title}</h1>
            <p class="text-slate-500">${defaultConfig.company_tagline}</p>
          </div>
          <div class="space-y-4">
            <button id="btnEmployee" class="w-full py-3 rounded bg-[color:var(--primary)] text-white font-semibold">üë§ Absensi Karyawan</button>
            <button id="btnAdmin" class="w-full py-3 rounded bg-[color:var(--secondary)] text-white font-semibold">‚öôÔ∏è Dashboard Admin</button>
          </div>
        </div>
      </div>`;
  }

  function renderAttendance(){
    return `
      <div class="max-w-xl mx-auto p-6">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="text-xl font-bold">Portal Karyawan</h2>
            <p class="text-slate-500">Absensi, Cuti & Lembur</p>
          </div>
          <button id="btnBackLogin" class="px-3 py-2 rounded bg-slate-200 text-slate-700">‚Üê Kembali</button>
        </div>

        <div class="card p-6">
          <label class="block text-sm font-medium mb-2">Masukkan NIK</label>
          <input id="nikInput" class="w-full border rounded px-3 py-2 mb-4" placeholder="Contoh: EMP001" />
          <div class="grid grid-cols-2 gap-3">
            <button id="btnCheckin" class="py-3 rounded bg-emerald-600 text-white font-semibold">üü¢ Absen Masuk</button>
            <button id="btnCheckout" class="py-3 rounded bg-orange-600 text-white font-semibold">üü† Absen Pulang</button>
          </div>
        </div>

        <div class="mt-8">
          <h3 class="text-lg font-semibold mb-3">Riwayat Hari Ini</h3>
          <div id="attendanceList" class="space-y-3"></div>
        </div>
      </div>`;
  }

  function renderAdmin(){
    const today = new Date().toISOString().split('T')[0];
    const todayAtt = attendances.filter(a=>a.waktu_absen.split('T')[0]===today);
    return `
      <div class="max-w-5xl mx-auto p-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold">Dashboard Admin</h2>
          <button id="btnLogout" class="px-3 py-2 rounded bg-slate-200 text-slate-700">Keluar</button>
        </div>

        <div class="grid md:grid-cols-3 gap-4">
          <div class="card p-5">
            <div class="text-sm text-slate-500">Karyawan Aktif</div>
            <div class="text-2xl font-bold">${employees.length}</div>
          </div>
          <div class="card p-5">
            <div class="text-sm text-slate-500">Absensi Hari Ini</div>
            <div class="text-2xl font-bold">${todayAtt.length}</div>
          </div>
          <div class="card p-5">
            <div class="text-sm text-slate-500">Roster Tersimpan</div>
            <div class="text-2xl font-bold">${rosters.length}</div>
          </div>
        </div>

        <div class="mt-6 card p-6">
          <div class="flex flex-wrap items-center gap-3 mb-4">
            <button id="btnGenRoster" class="px-4 py-2 rounded bg-[color:var(--primary)] text-white font-semibold">üìÖ Generate Roster Mingguan</button>
            <button id="btnClearRoster" class="px-4 py-2 rounded bg-rose-600 text-white font-semibold">üóëÔ∏è Hapus Semua Roster</button>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead>
                <tr class="text-left border-b">
                  <th class="py-2 pr-4">Tanggal</th>
                  <th class="py-2 pr-4">NIK</th>
                  <th class="py-2 pr-4">Nama</th>
                  <th class="py-2 pr-4">Shift</th>
                  <th class="py-2 pr-4">Keterangan</th>
                </tr>
              </thead>
              <tbody id="rosterTable">
                ${rosters.slice(0,100).map(r=>`
                  <tr class="border-b">
                    <td class="py-2 pr-4">${r.tanggal}</td>
                    <td class="py-2 pr-4">${r.nik}</td>
                    <td class="py-2 pr-4">${r.nama}</td>
                    <td class="py-2 pr-4">${getShiftLabel(r.shift_roster)}</td>
                    <td class="py-2 pr-4">${r.keterangan||''}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>

        <div class="mt-6 card p-6">
          <h3 class="text-lg font-semibold mb-3">Absensi Terbaru</h3>
          <div class="grid md:grid-cols-2 gap-3" id="adminAttendance"></div>
        </div>
      </div>`;
  }

  function mountCommonHandlers(){
    // list absensi untuk employee view
    const list = document.getElementById('attendanceList');
    if (list){
      const today = new Date().toISOString().split('T')[0];
      const data = attendances
        .filter(a=>a.waktu_absen.split('T')[0]===today)
        .sort((a,b)=> new Date(b.waktu_absen)-new Date(a.waktu_absen));
      list.innerHTML = data.map(a=>`
        <div class="card p-4">
          <div class="flex justify-between items-center">
            <div>
              <div class="font-semibold">${a.nama} <span class="text-xs text-slate-500">(${a.nik})</span></div>
              <div class="text-sm text-slate-600">${formatDate(a.waktu_absen)} ‚Ä¢ ${formatTime(a.waktu_absen)} ‚Ä¢ ${getShiftLabel(a.shift_terdeteksi)}</div>
            </div>
            <div class="text-sm ${a.status_absen==='hadir'?'text-emerald-700':(a.status_absen==='terlambat'?'text-amber-700':'text-rose-700')}">
              ${a.status_absen.replace('-', ' ')}
            </div>
          </div>
        </div>
      `).join('');
    }

    // absensi kartu input dan tombol
    const nikInput = document.getElementById('nikInput');
    const btnIn = document.getElementById('btnCheckin');
    const btnOut = document.getElementById('btnCheckout');
    if (btnIn) btnIn.onclick = ()=> doAttendance((nikInput?.value||'').trim(), 'checkin');
    if (btnOut) btnOut.onclick = ()=> doAttendance((nikInput?.value||'').trim(), 'checkout');

    // login nav
    const back = document.getElementById('btnBackLogin');
    if (back) back.onclick = ()=>{ currentView='login'; currentRole=null; render(); };

    // admin buttons
    const gen = document.getElementById('btnGenRoster'); if (gen) gen.onclick = saveWeeklyRoster;
    const clr = document.getElementById('btnClearRoster'); if (clr) clr.onclick = clearRoster;

    // camera modal close
    const closeBtn = document.getElementById('closeCameraBtn'); if (closeBtn) closeBtn.onclick=stopCamera;
    const cancelBtn = document.getElementById('cancelCameraBtn'); if (cancelBtn) cancelBtn.onclick=stopCamera;

    // admin attendance grid
    const adminGrid = document.getElementById('adminAttendance');
    if (adminGrid){
      const latest = [...attendances].sort((a,b)=> new Date(b.waktu_absen)-new Date(a.waktu_absen)).slice(0,12);
      adminGrid.innerHTML = latest.map(a=>`
        <div class="card p-4">
          <div class="flex items-center gap-3">
            <div class="w-14 h-14 bg-slate-200 rounded overflow-hidden flex items-center justify-center">
              ${a.foto_data ? `<img src="${a.foto_data}" class="w-full h-full object-cover"/>` : 'üì∑'}
            </div>
            <div class="flex-1">
              <div class="font-semibold">${a.nama}</div>
              <div class="text-xs text-slate-600">${a.nik} ‚Ä¢ ${getShiftLabel(a.shift_terdeteksi)}</div>
              <div class="text-xs text-slate-500">${formatDate(a.waktu_absen)} ‚Ä¢ ${formatTime(a.waktu_absen)}</div>
            </div>
            <span class="text-xs px-2 py-1 rounded ${a.status_absen==='hadir'?'bg-emerald-100 text-emerald-700':(a.status_absen==='terlambat'?'bg-amber-100 text-amber-700':'bg-rose-100 text-rose-700')}">
              ${a.status_absen}
            </span>
          </div>
        </div>
      `).join('');
    }

    // logout
    const out = document.getElementById('btnLogout'); if (out) out.onclick=()=>{ currentView='login'; currentRole=null; render(); };

    // login buttons
    const be = document.getElementById('btnEmployee'); if (be) be.onclick=()=>{ currentRole='employee'; currentView='attendance'; render(); };
    const ba = document.getElementById('btnAdmin'); if (ba) ba.onclick=()=>{ currentRole='admin'; currentView='admin'; render(); };
  }

  async function render(){
    const app = document.getElementById('app');
    if (!app) return;
    try {
      if (currentView==='login') app.innerHTML = renderLogin();
      else if (currentView==='attendance') app.innerHTML = renderAttendance();
      else app.innerHTML = renderAdmin();
    } catch (e) {
      console.error('Render error:', e); app.innerHTML = `<div class='p-6 text-red-700'>Terjadi kesalahan saat render: ${e?.message||e}</div>`;
    }
    mountCommonHandlers();
  }

  // ========= BOOTSTRAP =========
  (async function bootstrap(){
    await refreshData();
    render();
  })();
  </script>
</body>
</html>
